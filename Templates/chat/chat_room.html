{% extends "base.html" %}
{% load static %}

{% block title %}{{ other_user.username }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block content %}

<!-- ================= MAIN CHAT LAYOUT ================= -->
<div class="whatsapp-mixed">

    <!-- ================= LEFT SIDEBAR ================= -->
    <aside class="left-sidebar">
        <div class="sidebar-top">
            <img class="sidebar-dp"
                 src="{% if request.user.profile.profile_pic %}
                        {{ request.user.profile.profile_pic.url }}
                      {% else %}
                        {% static 'images/default-avatar.png' %}
                      {% endif %}">
            <div class="chat-name">{{ request.user.username }}</div>
        </div>

        <nav class="chat-list">
            {% for chat in chats %}
            <a href="{{ chat.chat_url }}"
               class="chat-item {% if chat.other_user.username == other_user.username %}active{% endif %}"
               data-user-id="{{ chat.other_user.id }}">

                <div class="chat-avatar">
                    <img src="{% if chat.other_user.profile.profile_pic %}
                                {{ chat.other_user.profile.profile_pic.url }}
                              {% else %}
                                {% static 'images/default-avatar.png' %}
                              {% endif %}">
                </div>

                <div class="chat-meta">
                    <span class="chat-name">{{ chat.name }}</span>
                    <span class="chat-status offline"
                          id="status-{{ chat.other_user.id }}">
                        Offline
                    </span>
                </div>
            </a>
            {% endfor %}
        </nav>
    </aside>

    <!-- ================= RIGHT CHAT PANEL ================= -->
    <section class="chat-panel">

        <!-- ================= HEADER ================= -->
        <div class="chat-header">

            <!-- LEFT -->
            <div class="header-left">

                <!-- MOBILE BACK -->
                <a href="{% url 'chat:chat_list' %}" class="chat-back d-md-none">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>

                <img class="header-dp"
                     src="{% if other_user.profile.profile_pic %}
                            {{ other_user.profile.profile_pic.url }}
                          {% else %}
                            {% static 'images/default-avatar.png' %}
                          {% endif %}">

                <div>
                    <div class="chat-name">{{ other_user.username }}</div>
                    <div id="userStatus" class="chat-status offline">Offline</div>
                </div>

            </div>

            <!-- RIGHT -->
            <div class="header-actions">
                <button class="icon-btn" onclick="startCall('audio')">
                    <i class="fa-solid fa-phone"></i>
                </button>
                <button class="icon-btn" onclick="startCall('video')">
                    <i class="fa-solid fa-video"></i>
                </button>
                <button class="icon-btn">
                    <i class="fa-solid fa-ellipsis-vertical"></i>
                </button>
            </div>

        </div>

        <!-- ================= MESSAGES ================= -->
        <div id="messages" class="messages">
            {% for msg in messages %}
            <div class="message-row {% if msg.sender.id == request.user.id %}row-me{% else %}row-other{% endif %}">
                <div class="bubble {% if msg.sender.id == request.user.id %}me{% else %}other{% endif %}">
                    <p>{{ msg.content }}</p>
                    <div class="msg-meta">
                        {{ msg.timestamp|date:"h:i A" }}
                        {% if msg.sender.id == request.user.id %}
                            <span class="message-ticks">
                                {% if msg.seen %}âœ“âœ“{% elif msg.delivered %}âœ“âœ“{% else %}âœ“{% endif %}
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ================= COMPOSER ================= -->
        <div class="composer">

            <button id="emojiBtn" class="emoji-btn">
                <i class="fa-regular fa-face-smile"></i>
            </button>

            <button id="attachBtn" class="attach-btn">
                <i class="fa-solid fa-paperclip"></i>
            </button>

            <input id="messageInput"
                   type="text"
                   class="chat-input"
                   placeholder="Type a messageâ€¦"
                   autocomplete="off">

            <button id="sendBtn" class="send-btn">
                <i class="fa-solid fa-paper-plane"></i>
            </button>

            <div id="emojiPicker" class="emoji-picker hidden">
                <span>ğŸ˜€</span><span>ğŸ˜ƒ</span><span>ğŸ˜„</span><span>ğŸ˜</span>
                <span>ğŸ˜†</span><span>ğŸ˜…</span><span>ğŸ˜‚</span><span>ğŸ¤£</span>
                <span>ğŸ˜Š</span><span>ğŸ˜‡</span><span>ğŸ™‚</span>
                <span>ğŸ˜‰</span><span>ğŸ˜Œ</span><span>ğŸ˜</span><span>ğŸ˜˜</span>
                <span>ğŸ˜›</span><span>ğŸ˜œ</span>
                <span>ğŸ™</span><span>ğŸ‘</span><span>ğŸ‘</span><span>â¤ï¸</span>
            </div>

        </div>

    </section>
</div>

<!-- ================= CHAT DATA ================= -->
<div id="chat-data"
     data-conv-id="{{ conversation.id }}"
     data-user-id="{{ request.user.id }}"
     data-username="{{ request.user.username }}">
</div>

<!-- ================= CALL POPUPS ================= -->
<div id="incomingCallPopup" class="call-popup hidden">
    <div class="call-popup-inner">
        <h3 id="incomingCallerName">Incoming Call</h3>
        <p id="incomingCallType">Audio Call</p>
        <div class="call-popup-buttons">
            <button id="acceptCallBtn" class="accept-btn">Accept</button>
            <button id="rejectCallBtn" class="reject-btn">Reject</button>
        </div>
    </div>
</div>

<audio id="ringbackTone" loop>
    <source src="{% static 'sounds/outgoing_call.mp3' %}" type="audio/mpeg">
</audio>

<audio id="ringtone" loop>
    <source src="{% static 'sounds/incoming_call.mp3' %}" type="audio/mpeg">
</audio>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/chat.js' %}"></script>
{% endblock %}
